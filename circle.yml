general:
  branches:
    only:
      - testci

machine:
  environment:
    DOCKER_HOST: tcp://localhost:2375
    PATH: "$HOME/.local/bin:$PATH"

  services:
    - docker
  pre:
    - echo 'DOCKER_OPTS="${DOCKER_OPTS} -H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock"' | sudo tee -a /etc/default/docker

dependencies:
  cache_directories:
    - ~/.local

  override:
    - ./circle.sh cache > >(tee $CIRCLE_ARTIFACTS/cache.stdout.txt) 2> >(tee $CIRCLE_ARTIFACTS/cache.stderr.txt >&2)

test:
  override:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS quay.io:
        parallel: true
    - case $CIRCLE_NODE_INDEX in 0) ./circle.sh test centos-6 centos:6 ;; 1) ./circle.sh test centos-7 centos:7 ;; 2) ./circle.sh test AWS_EC2_Linux_2014_09 quay.io/signalfuse/collectd-build-amazon-linux-2014-09 ;; 3) ./circle.sh test AWS_EC2_Linux_2015_03 quay.io/signalfuse/collectd-build-amazon-linux-2015-03 ;; 4) ./circle.sh test AWS_EC2_Linux_2015_09 quay.io/signalfuse/collectd-build-amazon-linux-2015-09 ;; 5) ./circle.sh test debian none ;; esac:
        parallel: true
